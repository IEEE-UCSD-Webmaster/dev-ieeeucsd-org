---
import yaml from "js-yaml";
import profileConfig from "../config/profileConfig.yaml?raw";
import textConfig from "../config/text.yml?raw";

const title = "Dashboard";
const config = yaml.load(profileConfig) as any;
const text = yaml.load(textConfig) as any;
---

<!doctype html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title} | IEEE UCSD</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>
    <body class="bg-base-200">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="bg-base-100 w-80 flex flex-col shadow-lg">
                <!-- Logo -->
                <div class="p-4 border-b border-base-200">
                    <div class="flex items-center gap-2">
                        <img
                            src="/ieee-logo.png"
                            alt="IEEE Logo"
                            class="w-8 h-8"
                        />
                        <span class="text-xl font-bold">IEEE UCSD</span>
                    </div>
                </div>

                <!-- User Profile -->
                <div class="p-4 border-b border-base-200">
                    <div
                        class="flex items-center gap-3"
                        id="userProfileSummary"
                    >
                        <div class="avatar placeholder">
                            <div
                                class="w-12 h-12 rounded-full bg-primary text-primary-content"
                            >
                                <span class="text-xl" id="userInitials">?</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-medium" id="userName">
                                Loading...
                            </h3>
                            <p class="text-sm opacity-70" id="userRole">
                                Member
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto">
                    <ul class="menu p-4 gap-2 text-base-content">
                        <li class="menu-title"><span>Main Menu</span></li>
                        <li>
                            <button
                                class="dashboard-nav-btn active"
                                data-section="profile"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                                    ></path>
                                </svg>
                                Dashboard
                            </button>
                        </li>
                        <li>
                            <button
                                class="dashboard-nav-btn"
                                data-section="events"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                Events
                            </button>
                        </li>
                        <li>
                            <button
                                class="dashboard-nav-btn"
                                data-section="reimbursement"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                                    ></path>
                                </svg>
                                Reimbursement
                            </button>
                        </li>

                        <li class="menu-title mt-4"><span>Account</span></li>
                        <li>
                            <button
                                class="dashboard-nav-btn"
                                data-section="settings"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                Settings
                            </button>
                        </li>
                        <li>
                            <button id="logoutButton" class="text-error">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                Logout
                            </button>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-base-200">
                <!-- Mobile Header -->
                <header class="bg-base-100 p-4 shadow-md lg:hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button
                                id="mobileSidebarToggle"
                                class="btn btn-square btn-ghost"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <h1 class="text-xl font-bold">IEEE UCSD</h1>
                        </div>
                    </div>
                </header>

                <!-- Page Content -->
                <div class="p-6 max-w-[1600px] mx-auto">
                    <!-- Loading State -->
                    <div id="pageLoadingState" class="w-full">
                        <div
                            class="flex flex-col items-center justify-center p-8"
                        >
                            <div class="loading loading-spinner loading-lg">
                            </div>
                            <p class="mt-4 opacity-70">Loading dashboard...</p>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="pageErrorState" class="hidden w-full">
                        <div class="alert alert-error">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span>Failed to load dashboard content</span>
                        </div>
                    </div>

                    <!-- Not Authenticated State -->
                    <div id="notAuthenticatedState" class="hidden w-full">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body items-center text-center">
                                <div class="mb-6">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-16 w-16 opacity-30"
                                        viewBox="0 0 20 20"
                                        fill="currentColor"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h2 class="card-title text-2xl mb-2">
                                    Sign in to Access Dashboard
                                </h2>
                                <p class="opacity-70 mb-6">
                                    Please sign in with your IEEE UCSD account
                                    to access the dashboard.
                                </p>
                                <button
                                    class="login-button btn btn-primary btn-lg gap-2"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5"
                                        viewBox="0 0 20 20"
                                        fill="currentColor"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    Sign in with IEEEUCSD SSO
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div id="mainContent" class="hidden">
                        <!-- Dashboard Section -->
                        <div id="profileSection" class="dashboard-section">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold">
                                    Dashboard Overview
                                </h2>
                                <p class="opacity-70">
                                    Welcome to your IEEE UCSD dashboard
                                </p>
                            </div>

                            <!-- Stats Cards -->
                            <div
                                class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"
                            >
                                <div class="stats shadow">
                                    <div class="stat">
                                        <div class="stat-title">
                                            Events Attended
                                        </div>
                                        <div
                                            class="stat-value"
                                            id="eventsAttendedValue"
                                        >
                                            0
                                        </div>
                                        <div class="stat-desc">
                                            Since joining
                                        </div>
                                    </div>
                                </div>
                                <div class="stats shadow">
                                    <div class="stat">
                                        <div class="stat-title">
                                            Loyalty Points
                                        </div>
                                        <div
                                            class="stat-value text-primary"
                                            id="loyaltyPointsValue"
                                        >
                                            0
                                        </div>
                                        <div
                                            class="stat-desc"
                                            id="loyaltyPointsChange"
                                        >
                                            No recent activity
                                        </div>
                                    </div>
                                </div>
                                <div class="stats shadow">
                                    <div class="stat">
                                        <div class="stat-title">
                                            Activity Level
                                        </div>
                                        <div
                                            class="stat-value text-secondary"
                                            id="activityLevelValue"
                                        >
                                            Low
                                        </div>
                                        <div
                                            class="stat-desc"
                                            id="activityLevelDesc"
                                        >
                                            New Member
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dashboard Content -->
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">Recent Activity</h3>
                                    <div class="py-4">
                                        <p class="text-base-content/70">
                                            No recent activity to display.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Events Section -->
                        <div
                            id="eventsSection"
                            class="dashboard-section hidden"
                        >
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold">Events</h2>
                                <p class="opacity-70">
                                    View and manage your IEEE UCSD events
                                </p>
                            </div>
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">Upcoming Events</h3>
                                    <!-- Events content will go here -->
                                </div>
                            </div>
                        </div>

                        <!-- Reimbursement Section -->
                        <div
                            id="reimbursementSection"
                            class="dashboard-section hidden"
                        >
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold">
                                    Reimbursement
                                </h2>
                                <p class="opacity-70">
                                    Manage your reimbursement requests
                                </p>
                            </div>
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">
                                        Reimbursement Requests
                                    </h3>
                                    <!-- Reimbursement content will go here -->
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section -->
                        <div
                            id="settingsSection"
                            class="dashboard-section hidden"
                        >
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold">Settings</h2>
                                <p class="opacity-70">
                                    Manage your account settings
                                </p>
                            </div>
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h3 class="card-title">Account Settings</h3>
                                    <div class="py-4">
                                        <p class="text-base-content/70">
                                            Account settings will be available
                                            soon.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </body>
</html>

<script>
    import { Authentication } from "../components/pocketbase/Authentication";
    const auth = Authentication.getInstance();

    // Initialize page state
    const pageLoadingState = document.getElementById("pageLoadingState");
    const pageErrorState = document.getElementById("pageErrorState");
    const notAuthenticatedState = document.getElementById(
        "notAuthenticatedState"
    );
    const mainContent = document.getElementById("mainContent");
    const sidebar = document.querySelector("aside");

    // User profile elements
    const userInitials = document.getElementById("userInitials");
    const userName = document.getElementById("userName");
    const userRole = document.getElementById("userRole");

    // Mobile sidebar toggle
    const mobileSidebarToggle = document.getElementById("mobileSidebarToggle");
    if (mobileSidebarToggle && sidebar) {
        mobileSidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("-translate-x-full");
        });
    }

    // Handle navigation
    const handleNavigation = () => {
        const navButtons = document.querySelectorAll(".dashboard-nav-btn");
        const sections = document.querySelectorAll(".dashboard-section");

        navButtons.forEach((button) => {
            button.addEventListener("click", () => {
                // Remove active class from all buttons
                navButtons.forEach((btn) =>
                    btn.classList.remove("active", "bg-base-200")
                );
                // Add active class to clicked button
                button.classList.add("active", "bg-base-200");

                // Hide all sections
                sections.forEach((section) => section.classList.add("hidden"));
                // Show selected section
                const sectionId = `${button.getAttribute("data-section")}Section`;
                document.getElementById(sectionId)?.classList.remove("hidden");

                // Close sidebar on mobile after selection
                if (window.innerWidth < 1024 && sidebar) {
                    sidebar.classList.add("-translate-x-full");
                }
            });
        });
    };

    // Update user profile
    const updateUserProfile = (user: any) => {
        if (!user) return;

        if (userName) userName.textContent = user.name || "Unknown User";
        if (userRole) userRole.textContent = user.role || "Member";
        if (userInitials) {
            const initials = (user.name || "U")
                .split(" ")
                .map((n: string) => n[0])
                .join("")
                .toUpperCase();
            userInitials.textContent = initials;
        }
    };

    // Initialize page
    const initializePage = async () => {
        try {
            if (pageLoadingState) pageLoadingState.classList.remove("hidden");
            if (pageErrorState) pageErrorState.classList.add("hidden");
            if (notAuthenticatedState)
                notAuthenticatedState.classList.add("hidden");
            if (mainContent) mainContent.classList.add("hidden");

            // Check authentication
            if (!auth.isAuthenticated()) {
                if (pageLoadingState) pageLoadingState.classList.add("hidden");
                if (notAuthenticatedState)
                    notAuthenticatedState.classList.remove("hidden");
                return;
            }

            const user = auth.getCurrentUser();
            updateUserProfile(user);

            // Initialize navigation
            handleNavigation();

            // Show main content
            if (mainContent) mainContent.classList.remove("hidden");
            if (pageLoadingState) pageLoadingState.classList.add("hidden");
        } catch (error) {
            console.error("Error initializing dashboard:", error);
            if (pageLoadingState) pageLoadingState.classList.add("hidden");
            if (pageErrorState) pageErrorState.classList.remove("hidden");
        }
    };

    // Initialize when DOM is loaded
    document.addEventListener("DOMContentLoaded", initializePage);

    // Handle login button click
    document
        .querySelector(".login-button")
        ?.addEventListener("click", async () => {
            try {
                if (pageLoadingState)
                    pageLoadingState.classList.remove("hidden");
                if (notAuthenticatedState)
                    notAuthenticatedState.classList.add("hidden");
                await auth.login();
            } catch (error) {
                console.error("Login error:", error);
                if (pageLoadingState) pageLoadingState.classList.add("hidden");
                if (pageErrorState) pageErrorState.classList.remove("hidden");
            }
        });

    // Handle logout button click
    document.getElementById("logoutButton")?.addEventListener("click", () => {
        auth.logout();
        window.location.reload();
    });

    // Handle responsive sidebar
    if (sidebar) {
        // Hide sidebar by default on mobile
        if (window.innerWidth < 1024) {
            sidebar.classList.add("-translate-x-full");
        }

        // Add transition class
        sidebar.classList.add(
            "transition-transform",
            "duration-300",
            "ease-in-out",
            "lg:translate-x-0",
            "fixed",
            "lg:relative",
            "h-full",
            "z-50"
        );
    }
</script>

<style>
    .dashboard-nav-btn.active {
        @apply bg-base-200 font-medium;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .overflow-y-auto::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .overflow-y-auto {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
</style>
